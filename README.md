# Earth-Science-Data-Analyze

This repo is used as analyzing earth quake staticies.

以下內容由Claude提供並經由人類修改。

# 實驗數據分析程式說明文件

## 一、程式架構

本分析系統分為兩個獨立的腳本：

1. **analysis_file1to4.py** - 分析 file 1-4 的數據（同一實驗組）
2. **analysis_file5.py** - 分析 file 5 的數據（另一實驗組）

兩個腳本的核心邏輯相同，僅在資料來源上有所區別。

---

## 二、異常值過濾機制

### 2.1 過濾邏輯

函數：`filter_outliers(data, threshold=0.1)`

**判定標準：**
若第 i 筆數據與第 i-1 筆數據的差值超過 0.1，則第 i 筆數據被標記為異常值。

**數學表示：**
```
如果 |data[i] - data[i-1]| > 0.1，則 data[i] 為異常值
```

**實作方式：**
1. 建立布林遮罩 (boolean mask)，初始全部設為 True（有效）
2. 逐一檢查相鄰數據點的差值
3. 超過閾值的數據點，其遮罩設為 False（無效）
4. 回傳遮罩，用於過濾數據

### 2.2 適用範圍

**會進行異常值過濾的數據：**
- 位移數據：x, y (俯瞰視角)
- 各層位移：ye, yd, yc, yb, ya (側面視角)
- 加速度數據：Absolute acceleration

**不進行異常值過濾的數據：**
- 時間軸：t_s, t_a（僅進行基本清理和歸零）

### 2.3 過濾後處理

過濾後的數據會進行：
1. 去中心化（減去平均值），使數據以 0 為中心
2. 用於後續的 RMS、FFT 等計算

---

## 三、不確定度計算邏輯

### 3.1 理論基礎

不確定度計算基於 **A 類不確定度評估**（Type A evaluation），適用於重複測量的統計分析。

對於每個實驗組（如 G1, G2, ...），我們有 n 次重複實驗的測量值。

### 3.2 計算步驟

#### 步驟 1：計算平均值
```
x̄ = (1/n) × Σ(xi)
```
其中：
- xi 為第 i 次測量值
- n 為有效測量次數（排除 NaN 值後）

#### 步驟 2：計算樣本標準差
```
s = sqrt[(1/(n-1)) × Σ(xi - x̄)²]
```
使用 **貝塞爾校正**（Bessel's correction），除以 (n-1) 而非 n，以得到無偏估計。

#### 步驟 3：計算標準不確定度
```
u = s / sqrt(n)
```
這是平均值的標準不確定度，也稱為「標準誤差」(Standard Error of the Mean, SEM)。

#### 步驟 4：計算相對不確定度
```
相對不確定度 (%) = (u / x̄) × 100%
```
表示不確定度相對於測量值的百分比。

### 3.3 物理意義

- **平均值 (x̄)**：多次測量的最佳估計值
- **標準差 (s)**：測量值的離散程度
- **標準不確定度 (u)**：平均值的不確定性
- **相對不確定度**：測量精確度的指標

### 3.4 適用參數

對每個實驗組的以下參數計算不確定度：
1. RMS_x：x 方向均方根位移
2. RMS_y：y 方向均方根位移
3. ratio：偏心比例（RMS_y / RMS_x）
4. f_n：系統自然頻率
5. k：等效剛性
6. rms_acc：加速度均方根

### 3.5 樣本數要求

- **n ≥ 2**：可計算標準差和不確定度
- **n = 1**：僅記錄平均值，不確定度標記為 NaN
- **n = 0**：所有值標記為 NaN

---

## 四、數據處理流程

### 4.1 完整流程圖

```
原始數據
    ↓
移除非數值資料 (pd.to_numeric)
    ↓
轉換為浮點數
    ↓
[時間數據] 歸零（減去第一個值）
    ↓
[測量數據] 過濾異常值 (|diff| > 0.1)
    ↓
[測量數據] 去中心化（減去平均值）
    ↓
用於計算 (RMS, FFT, 等)
    ↓
儲存至群組數據
    ↓
計算不確定度
```

### 4.2 關鍵函數

#### `clean_data_with_outlier_filter(data, time_data=None)`

**參數：**
- `data`：原始數據陣列
- `time_data`：若為 None 則視為時間數據；否則視為測量數據

**處理邏輯：**
```python
if time_data is None:  # 時間數據
    1. 移除非數值
    2. 轉換為 float
    3. 歸零（減去第一個值）
else:  # 測量數據
    1. 移除非數值
    2. 轉換為 float
    3. 過濾異常值
    4. 去中心化
```

---

## 五、輸出檔案說明

### 5.1 詳細結果檔案

**檔名：**
- `analysis_results_file1to4.csv`
- `analysis_results_file5.csv`

**欄位：**
| 欄位名稱 | 說明 |
|---------|------|
| File | 檔案路徑 |
| Group | 實驗組別（G1, G2, ...） |
| RMS_x | x 方向均方根位移 |
| RMS_y | y 方向均方根位移 |
| 偏心比例 | RMS_y / RMS_x |
| 主頻率(Hz) | 系統自然頻率 |
| 等效剛性(N/m) | k = m × (2πf)² |
| RMS加速度 | 加速度均方根 |

### 5.2 不確定度統計檔案

**檔名：**
- `uncertainty_file1to4.csv`
- `uncertainty_file5.csv`

**欄位：**
| 欄位名稱 | 說明 |
|---------|------|
| Group | 實驗組別 |
| RMS_x_mean | RMS_x 平均值 |
| RMS_x_u | RMS_x 標準不確定度 |
| RMS_y_mean | RMS_y 平均值 |
| RMS_y_u | RMS_y 標準不確定度 |
| ratio_mean | 偏心比例平均值 |
| ratio_u | 偏心比例標準不確定度 |
| f_n_mean | 主頻率平均值 |
| f_n_u | 主頻率標準不確定度 |
| k_mean | 等效剛性平均值 |
| k_u | 等效剛性標準不確定度 |
| rms_acc_mean | RMS加速度平均值 |
| rms_acc_u | RMS加速度標準不確定度 |
| sample_size | 有效樣本數 |

---

## 六、數學公式彙整

### 6.1 RMS（均方根）
```
RMS = sqrt[(1/n) × Σ(xi²)]
```

### 6.2 偏心比例
```
ratio = RMS_y / RMS_x
```

### 6.3 FFT 頻率分析
```
1. 傅立葉轉換: Y(f) = FFT(y(t))
2. 頻率軸: f = fftfreq(N, dt)
3. 振幅: A(f) = |Y(f)| × (2/N)
4. 主頻率: f_n = argmax(A(f)) for f > 0
```

### 6.4 等效剛性
```
k = m × ω²
其中 ω = 2πf_n
即 k = m × (2πf_n)²
```

### 6.5 不確定度
```
標準差: s = sqrt[(1/(n-1)) × Σ(xi - x̄)²]
標準不確定度: u = s / sqrt(n)
相對不確定度: ur = (u / x̄) × 100%
```

---

## 七、使用注意事項

### 7.1 數據要求
- Excel 檔案必須包含至少 6 欄（側面）+ 3 欄（俯瞰）
- CSV 檔案必須以逗號分隔
- 時間序列應為遞增數列

### 7.2 異常值閾值
- 目前設定為 0.1（公尺或加速度單位）
- 可根據實驗特性調整 `threshold` 參數

### 7.3 質量設定
- 目前設定為 1.8559 kg
- 若實驗質量改變，需修改 `mass` 變數

### 7.4 檔案結構要求
- xlsx 和 zip 檔案必須同名
- zip 檔案內必須包含 Raw Data.csv
- 資料夾命名必須遵循 "數字-Gn-編號" 格式

---

## 八、錯誤處理

程式包含以下錯誤處理機制：

1. **檔案讀取失敗**：跳過該檔案，繼續處理下一個
2. **數據長度不足**：跳過該層的 FFT 計算
3. **除以零**：使用條件判斷避免（如 RMS_x < 1e-8）
4. **NaN 值**：自動過濾，不納入統計計算
5. **ZIP 檔案錯誤**：標記加速度為 NaN

---

## 九、程式優化建議

### 9.1 已實作的優化
- 使用布林遮罩過濾，避免迴圈
- 向量化計算（numpy）
- 錯誤處理與異常捕獲

### 9.2 可能的改進方向
1. 多執行緒處理多個檔案
2. 視覺化輸出（繪製頻譜圖、時序圖）
3. 自動生成實驗報告
4. 交互式參數調整介面

---

## 十、參考文獻與標準

- GUM (Guide to the Expression of Uncertainty in Measurement)
- ISO/IEC Guide 98-3:2008
- 實驗誤差與不確定度分析理論
